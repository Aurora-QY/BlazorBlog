@page "/new-post"
@inject NavigationManager NavigationManager
@inject MarkdownRenderer MarkdownRenderer
@inject IPostService PostService
@inject IJSRuntime JSRuntime

@* 姑且用这个当顶边距吧 *@
<div>
    <p></p>
    <p></p>
    <p></p>
    <p></p>
</div>
<div class="new-post-container">
    <div class="edit-section">
        <h3>创建新博客</h3>

        <EditForm Model="@newPost" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="title">标题</label>
                <InputText id="title" @bind-Value="newPost.Title" class="form-control" />
                <ValidationMessage For="@(() => newPost.Title)" />
            </div>

            <div class="form-group">
                <label for="summary">摘要</label>
                <InputTextArea id="summary" @bind-Value="newPost.Summary" class="form-control" rows="3" />
                <ValidationMessage For="@(() => newPost.Summary)" />
            </div>

            <div class="form-group">
                <label for="imageUrl">图片 URL</label>
                <InputText id="imageUrl" @bind-Value="newPost.ImageUrl" class="form-control" />
            </div>

            <div class="form-group">
                <label for="content">内容</label>
                <InputTextArea id="content" @bind-Value="newPost.Content" class="form-control" rows="15"
                    @oninput="OnContentChange" />
                <ValidationMessage For="@(() => newPost.Content)" />
            </div>

            <div class="markdown-tools">
                <button type="button" class="btn btn-secondary" @onclick="InsertBold">粗体</button>
                <button type="button" class="btn btn-secondary" @onclick="InsertItalic">斜体</button>
                <button type="button" class="btn btn-secondary" @onclick="InsertLink">链接</button>
                <button type="button" class="btn btn-secondary" @onclick="InsertImage">图片</button>
            </div>

            <button type="submit" class="btn btn-primary mt-3">发布博客</button>
        </EditForm>
        <Notification IsVisible="@showNotification" Message="@notificationMessage" />
    </div>

    <div class="preview-section">
        <h3>预览</h3>
        <div class="markdown-preview">
            @((MarkupString)renderedContent)
        </div>
    </div>
</div>

@code {
    private PostDto newPost = new PostDto();
    private bool showNotification = false;
    private string notificationMessage = "";
    private string renderedContent = "Markdown 渲染预览区域";

    protected override void OnInitialized()
    {
        // 设置默认值
        var currentTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
        newPost.Title = $"这是一条测试~~~";
        newPost.Summary = $"这是一条摘要~Hello World!";
        newPost.ImageUrl = "http://imgapi.xl0408.top/index.php";
        newPost.Content = @"# 欢迎使用 Markdown

## 这是二级标题

### 这是三级标题

这是普通段落文本。**这是粗体**，*这是斜体*，***这是粗斜体***。

- 这是无序列表项 1
- 这是无序列表项 2
- 这是嵌套列表项

1. 这是有序列表项 1
2. 这是有序列表项 2

> 这是一段引用文本。

[这是一个链接:同济1系统](https://1.tongji.edu.cn)

![这是一张图片:随机图片](http://imgapi.xl0408.top/index.php)

```csharp
public class Example
{
public void Method()
{
Console.WriteLine(""Hello, World!"");
}
}";

        // 初始化时也更新预览
        UpdatePreview();
    }

    private async Task HandleValidSubmit()
    {

        try
        {
            // 将 UTC 时间转换为北京时间
            TimeZoneInfo beijingTimeZone = TimeZoneInfo.FindSystemTimeZoneById("China Standard Time");
            newPost.CreatedAt = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, beijingTimeZone);

            // TODO:替换为实际的用户ID，或者从认证系统中获取
            newPost.AuthorId = 1; // 这里因为目前还是个人博客，所以就写死了
            Console.WriteLine(newPost.AuthorId.ToString(), newPost.AuthorName);
            await PostService.CreatePostAsync(newPost);

            showNotification = true;
            notificationMessage = "博文发表成功！";
            StateHasChanged();

            await Task.Delay(2000); // 延迟 2 秒

            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            // 处理错误
            notificationMessage = "发表失败：" + ex.Message;
            showNotification = true;
            StateHasChanged();
        }
    }


    private void OnContentChange(ChangeEventArgs e)
    {
        newPost.Content = e.Value.ToString();
        UpdatePreview();
    }

    private void UpdatePreview()
    {

        renderedContent = MarkdownRenderer.RenderToHtml(newPost.Content);
    }

    private async Task InsertBold()
    {
        await JSRuntime.InvokeVoidAsync("insertText", "content", "**粗体文本**");
    }

    private async Task InsertItalic()
    {
        await JSRuntime.InvokeVoidAsync("insertText", "content", "*斜体文本*");
    }

    private async Task InsertLink()
    {
        await JSRuntime.InvokeVoidAsync("insertText", "content", "[链接文本](http://example.com)");
    }

    private async Task InsertImage()
    {
        await JSRuntime.InvokeVoidAsync("insertText", "content", "![图片描述](http://example.com/image.jpg)");
    }
}